# Time-LLM + 小波：最值得做的5个创新点（按ROI优先级）

> 目标：在不破坏 Time-LLM“重编程+冻结LLM”范式的前提下，用小波的多尺度时频优势提升精度、稳健性与效率。只给思路，不给代码。

## 1) 小波统计驱动的 Prompt 增强（最低成本，见效快）
- **核心**：将小波多尺度统计写入提示，替代/补充现有的 `min/max/median/lag`，让LLM有“频带先验”与任务语义。
- **接入点**：[models/TimeLLM.py](cci:7://file:///home/dmx_MT/LZF/project/Time-LLM/models/TimeLLM.py:0:0-0:0) 的 [forecast](cci:1://file:///home/dmx_MT/LZF/project/Time-LLM/models/TimeLLM.py:219:4-274:22) 中生成 `prompt` 的逻辑。
- **MVP内容**：
  - 各尺度能量占比、主导尺度与对应周期（scale→period）、小波熵、突发区间的时标。
  - 控制提示长度：聚合统计、Top-K 频带摘要、阈值筛选。
- **预期收益**：长/短期信息权衡更稳，异常/周期更易被捕捉；提示可解释。
- **评估**：整体 MSE/MAE；分尺度误差（小波域）；与“仅时域统计”的消融对比。

## 2) 多尺度 Wavelet-Patch Tokens（作为新型token并/替现有patch）
- **核心**：将序列做 DWT/WPD 得到“尺度×时间”的系数块，作为 token 输入（单独流或与现有 [PatchEmbedding](cci:2://file:///home/dmx_MT/LZF/project/Time-LLM/layers/Embed.py:230:0-266:38) 并联）。
- **接入点**：在 [layers/Embed.py](cci:7://file:///home/dmx_MT/LZF/project/Time-LLM/layers/Embed.py:0:0-0:0) 增设 `WaveletPatchEmbedding`（概念上），在 [models/TimeLLM.py](cci:7://file:///home/dmx_MT/LZF/project/Time-LLM/models/TimeLLM.py:0:0-0:0) 中替换/并联调用。
- **MVP内容**：
  - 3–5 层分解，保留 A_J + 若干高能 D_j；统一映射到 `d_model`；加入“Scale-ID”嵌入。
  - 并联融合先用简单拼接或加权平均，后续再做注意力融合。
- **预期收益**：更强的非平稳捕捉与多周期建模，token 语义更结构化。
- **评估**：在高波动/多周期数据集上相对提升；token 数量、显存、吞吐的开销曲线。

## 3) 低/高频双流重编程（频带解耦 → 更精准的跨模态对齐）
- **核心**：把小波低频（趋势）与高频（细节/事件）分两路，分别过各自的 [ReprogrammingLayer](cci:2://file:///home/dmx_MT/LZF/project/Time-LLM/models/TimeLLM.py:286:0-336:38)，再门控融合送入 LLM。
- **接入点**：[models/TimeLLM.py](cci:7://file:///home/dmx_MT/LZF/project/Time-LLM/models/TimeLLM.py:0:0-0:0) 中复制两套 [ReprogrammingLayer](cci:2://file:///home/dmx_MT/LZF/project/Time-LLM/models/TimeLLM.py:286:0-336:38)，在 [forecast](cci:1://file:///home/dmx_MT/LZF/project/Time-LLM/models/TimeLLM.py:219:4-274:22) 将 LF/HF token 分流与融合。
- **MVP内容**：
  - LF 流强调长期模式；HF 流强调突发/振荡；门控系数可学习或由能量统计引导。
  - KV 原型可复用现有 `mapping_layer` 产出的“语义原型”，LF/HF 使用不同原型子集。
- **预期收益**：让LLM在两类模式上“各司其职”，长/短期精度共同提升。
- **评估**：长地平线误差、事件区间误差（峰/突发检测窗口）；注意力热图在不同流上的聚焦程度。

## 4) 小波域一致性损失 + 课程学习（优化目标升级）
- **核心**：在时域 MSE 外，加入小波域分尺度损失，先学低频后放大学高频权重（课程学习）。
- **接入点**：训练脚本的损失汇总位置（如 `run_main.py`）；对预测与真值做 DWT 并加权对齐。
- **MVP内容**：
  - 分尺度权重（低频先大后小，高频先小后大）；仅在验证有效时逐步提高权重，避免不稳定。
- **预期收益**：保证“波形形状与频带能量”一致，不再只优化平均误差。
- **评估**：分尺度 MSE、主导尺度一致性、能量分布 KL 散度；对异常/节假日等“结构性片段”的改进。

## 5) 小波能量驱动的 Token 稀疏化（效率红利，适配长序列）
- **核心**：依据小波能量/熵/方差为 token 打分，仅保留 Top-K 进入 `ReprogrammingLayer/LLM`，其余池化或丢弃。
- **接入点**：`PatchEmbedding/（WaveletPatchEmbedding）` 与 [ReprogrammingLayer](cci:2://file:///home/dmx_MT/LZF/project/Time-LLM/models/TimeLLM.py:286:0-336:38) 之间的选择器。
- **MVP内容**：
  - 固定 K 或占比阈值；优先保留主导尺度与高能时段；对提示 token 不做剪枝。
- **预期收益**：显著降显存与延迟，支持更长 `seq_len` 与更大批量；在轻微精度损失下获得可观吞吐提升。
- **评估**：速度/显存/精度三维权衡曲线；在长序列基准（如 ETT 长窗）下的综合优势。

---

## 落地顺序建议（从快到稳）
- **Step 1**：做“Prompt 小波统计增强”（方向1）验证净增益与鲁棒性。
- **Step 2**：并联“Wavelet-Patch Tokens”（方向2），用简单融合先拿到效果。
- **Step 3**：加入“多尺度损失 + 课程学习”（方向4），提升频带一致性。
- **Step 4**：升级为“低/高频双流重编程”（方向3），优化跨模态对齐。
- **Step 5**：引入“能量稀疏化”（方向5），把精度红利转化为可部署的效率优势。

---

# 总结
- 已给出5个最值得做的创新点，并按投入产出与工程复杂度排序，明确了接入模块、MVP落地要点、收益与评估方式。  
- 如你需要，我可以基于当前仓库进一步细化每个方向对应的具体参数、数据形状与消融计划，以便你按周推进。