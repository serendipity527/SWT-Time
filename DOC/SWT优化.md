

## WaveletEmbed æ¨¡å—åˆ†æ

### ä¼˜ç‚¹ âœ…

1. **GPU åŠ é€Ÿ**ï¼šä½¿ç”¨ `ptwt` å®ç°æ‰¹é‡å°æ³¢å˜æ¢ï¼Œæµ‹è¯•æ˜¾ç¤º ~1ms å¤„ç† 32Ã—7Ã—512 æ•°æ®
2. **å¤šå°ºåº¦ç‰¹å¾**ï¼šSWT ä¿ç•™æ‰€æœ‰é¢‘æ®µä¿¡æ¯ï¼ˆè¿‘ä¼¼+ç»†èŠ‚ç³»æ•°ï¼‰
3. **æ—¶é—´å±€éƒ¨æ€§**ï¼špatch å†…ä¿æŒå¤šå°ºåº¦ç‰¹å¾å¯¹é½
4. **çµæ´»é…ç½®**ï¼šæ”¯æŒä¸åŒå°æ³¢åŸºã€åˆ†è§£å±‚æ•°ã€`use_all_coeffs` å¼€å…³

---

### å­˜åœ¨çš„é—®é¢˜ âš ï¸

| é—®é¢˜ | ä½ç½® | è¯´æ˜ |
|------|------|------|
| **æœªä½¿ç”¨å˜é‡** | L39 [device](cci:1://file:///home/dmx_MT/LZF/project/SWT-Time/test/test_wavelet_embed_comprehensive.py:27:0-30:71), L40 `dtype` | å®šä¹‰åæœªä½¿ç”¨ï¼Œå†—ä½™ä»£ç  |
| **self.mode æœªä½¿ç”¨** | L28 | è®¾ç½®äº† mode ä½† `ptwt_swt` æœªä¼ å…¥ |
| **èƒ½é‡å®ˆæ’å¤±è´¥** | æµ‹è¯•å¤±è´¥ | èƒ½é‡æ¯”ç‡ 3.87ï¼Œè¯´æ˜ SWT ç³»æ•°å­˜åœ¨å†—ä½™ï¼ˆSWT ç‰¹æ€§ï¼‰ |
| **é‡å¤ç±»å‹è½¬æ¢** | L43-44, L154-155, L213-214 | å¤šå¤„æ£€æŸ¥ dtypeï¼Œå¯ç»Ÿä¸€å¤„ç† |
| **ç¡¬ç¼–ç æ³¨é‡Š** | L170 | å†™æ­» `(B, N, 4, T)` åº”ä¸º `(B, N, level+1, T)` |
| **ReplicationPad1d å†—ä½™** | L231-278 | å¯ç”¨ `F.pad(..., mode='replicate')` æ›¿ä»£ |

---

### æ”¹è¿›å»ºè®® ğŸš€

#### 1. å¯å­¦ä¹ çš„é¢‘æ®µåŠ æƒ
```python
# ä¸åŒé¢‘æ®µé‡è¦æ€§ä¸åŒï¼Œå¢åŠ å¯å­¦ä¹ æƒé‡
self.band_weights = nn.Parameter(torch.ones(swt_level + 1))

# forward ä¸­ï¼š
coeffs = coeffs * self.band_weights.view(1, 1, 1, -1)
```

#### 2. é¢‘æ®µç‹¬ç«‹æŠ•å½±ï¼ˆæ›¿ä»£ç®€å• flattenï¼‰
```python
# æ¯ä¸ªé¢‘æ®µç”¨ç‹¬ç«‹ Linear æŠ•å½±ï¼Œç„¶åèåˆ
self.band_projections = nn.ModuleList([
    nn.Linear(patch_len, d_model // (swt_level + 1)) 
    for _ in range(swt_level + 1)
])
```

#### 3. æ·»åŠ ä½ç½®ç¼–ç 
```python
# Patch çº§åˆ«ä½ç½®ç¼–ç 
self.pos_embed = nn.Parameter(torch.zeros(1, max_patches, d_model))
```

#### 4. æ··åˆç²¾åº¦æ”¯æŒ
```python
# ä½¿ç”¨ autocast è€Œéæ‰‹åŠ¨è½¬æ¢
@torch.cuda.amp.autocast(enabled=False)
def forward(self, x):
    x = x.float()  # ç»Ÿä¸€åœ¨å…¥å£è½¬æ¢
    ...
```

#### 5. å°æ³¢åŸºå¯å­¦ä¹ ï¼ˆé«˜çº§ï¼‰
```python
# ä½¿ç”¨å¯å­¦ä¹ çš„æ»¤æ³¢å™¨æ›¿ä»£å›ºå®šå°æ³¢
self.lowpass = nn.Parameter(torch.tensor(pywt.Wavelet('db4').dec_lo))
self.highpass = nn.Parameter(torch.tensor(pywt.Wavelet('db4').dec_hi))
```

#### 6. ç®€åŒ–ä»£ç 
```python
# åˆ é™¤æœªä½¿ç”¨å˜é‡
def forward(self, x):
    B, N, T = x.shape
    x = x.float()  # ç»Ÿä¸€è½¬æ¢
    ...

# ä½¿ç”¨ PyTorch å†…ç½® pad
F.pad(x, (0, stride), mode='replicate')
```

---

### æ€§èƒ½ä¼˜åŒ–æ–¹å‘

| æ–¹å‘ | é¢„æœŸæ”¶ç›Š | å¤æ‚åº¦ |
|------|----------|--------|
| èåˆ SWT + Patching ä¸ºå•ä¸€ kernel | å‡å°‘ ~30% æ—¶é—´ | é«˜ |
| ä½¿ç”¨ `torch.compile` | å‡å°‘ 10-20% | ä½ |
| ç¼“å­˜å°æ³¢æ»¤æ³¢å™¨åˆ° GPU buffer | å¾®å°æå‡ | ä½ |
| æ”¯æŒ FP16 ç›´æ¥è®¡ç®— | å‡å°‘æ˜¾å­˜ 50% | ä¸­ |

éœ€è¦æˆ‘å®ç°å…¶ä¸­æŸäº›æ”¹è¿›å—ï¼Ÿ








## æ•´ä½“ç½‘ç»œç»“æ„åˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Time-LLM å®Œæ•´æµç¨‹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  è¾“å…¥ x_enc (B, T, N)                                                        â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚  â”‚ Normalize   â”‚  RevIN æ ‡å‡†åŒ–                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼ reshape (B, N, T)                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚     WaveletPatchEmbedding (ä½ çš„æ¨¡å—)             â”‚                        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                        â”‚
â”‚  â”‚  â”‚ SWTåˆ†è§£ â†’ (B,N,T,level+1)                  â”‚  â”‚                        â”‚
â”‚  â”‚  â”‚    â†“                                      â”‚  â”‚                        â”‚
â”‚  â”‚  â”‚ Patching â†’ (B,N,num_patches,patch_len*4)  â”‚  â”‚                        â”‚
â”‚  â”‚  â”‚    â†“                                      â”‚  â”‚                        â”‚
â”‚  â”‚  â”‚ Conv1d Embedding â†’ (B*N, patches, d_model)â”‚  â”‚                        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  ReprogrammingLayer  â”‚â—„â”€â”€â”€â”‚ Word Embeddings      â”‚                       â”‚
â”‚  â”‚  (Cross-Attention)   â”‚    â”‚ (LLM vocabulary)     â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼ concat with prompt                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚  â”‚ LLM Backboneâ”‚  LLaMA / GPT2 / BERT                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚  â”‚ FlattenHead â”‚  æŠ•å½±åˆ°é¢„æµ‹é•¿åº¦                                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  è¾“å‡º (B, pred_len, N)                                                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## WaveletEmbed åœ¨æ¶æ„ä¸­çš„å…³é”®ä½œç”¨

| é˜¶æ®µ | åŸå§‹ PatchEmbedding | WaveletPatchEmbedding |
|------|---------------------|------------------------|
| è¾“å…¥ | åŸå§‹æ—¶é—´åºåˆ— | SWT å¤šå°ºåº¦åˆ†è§£ |
| ç‰¹å¾ç»´åº¦ | `patch_len` | `patch_len Ã— (level+1)` |
| ä¿¡æ¯ | å•ä¸€å°ºåº¦ | è¿‘ä¼¼ + å¤šå±‚ç»†èŠ‚ |

**å…³é”®çº¦æŸ**ï¼šè¾“å‡ºå¿…é¡»æ˜¯ `(B*N, num_patches, d_model)`ï¼Œä¸ [ReprogrammingLayer](cci:2://file:///home/dmx_MT/LZF/project/SWT-Time/models/TimeLLM.py:283:0-321:38) å¯¹æ¥ã€‚

---

## é’ˆå¯¹æ¶æ„çš„ä¼˜åŒ–å»ºè®®

### 1. é¢‘æ®µæ„ŸçŸ¥çš„ä½ç½®ç¼–ç ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
å½“å‰ç¼ºå°‘ä½ç½®ä¿¡æ¯ï¼ŒLLM ä¾èµ–ä½ç½®å…³ç³»ç†è§£åºåˆ—ï¼š
```python
class WaveletPatchEmbedding(nn.Module):
    def __init__(self, ...):
        ...
        # æ·»åŠ  patch çº§ä½ç½®ç¼–ç 
        max_patches = (seq_len // stride) + 2
        self.pos_embed = nn.Parameter(torch.zeros(1, max_patches, d_model))
        nn.init.trunc_normal_(self.pos_embed, std=0.02)
    
    def forward(self, x):
        ...
        x_embed = x_embed + self.pos_embed[:, :x_embed.shape[1], :]
        return x_embed, n_vars
```

### 2. é¢‘æ®µç‹¬ç«‹æŠ•å½± + èåˆï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
å½“å‰ç®€å• flatten ä¸¢å¤±äº†é¢‘æ®µç»“æ„ï¼Œç”¨ç‹¬ç«‹æŠ•å½±ä¿ç•™è¯­ä¹‰ï¼š
```python
class BandAwareProjection(nn.Module):
    """æ¯ä¸ªé¢‘æ®µç‹¬ç«‹ç¼–ç åèåˆ"""
    def __init__(self, patch_len, swt_level, d_model):
        super().__init__()
        self.n_bands = swt_level + 1
        d_band = d_model // self.n_bands
        
        # æ¯ä¸ªé¢‘æ®µç‹¬ç«‹æŠ•å½±
        self.band_projs = nn.ModuleList([
            nn.Linear(patch_len, d_band) for _ in range(self.n_bands)
        ])
        # é¢‘æ®µäº¤äº’
        self.fusion = nn.Linear(d_band * self.n_bands, d_model)
    
    def forward(self, x_patch):
        # x_patch: (B*N, num_patches, patch_len, n_bands)
        band_outs = [proj(x_patch[..., i]) for i, proj in enumerate(self.band_projs)]
        fused = torch.cat(band_outs, dim=-1)
        return self.fusion(fused)
```

### 3. å¯å­¦ä¹ é¢‘æ®µæƒé‡ï¼ˆä½æˆæœ¬é«˜æ”¶ç›Šï¼‰
ä¸åŒä»»åŠ¡å¯èƒ½éœ€è¦ä¸åŒé¢‘æ®µçš„é‡è¦æ€§ï¼š
```python
# åœ¨ __init__ ä¸­
self.band_weights = nn.Parameter(torch.ones(swt_level + 1))

# åœ¨ forward ä¸­ï¼ŒSWTåˆ†è§£å
coeffs = coeffs * F.softmax(self.band_weights, dim=0).view(1, 1, 1, -1)
```

### 4. ä¸ ReprogrammingLayer ååŒä¼˜åŒ–
å½“å‰ [ReprogrammingLayer](cci:2://file:///home/dmx_MT/LZF/project/SWT-Time/models/TimeLLM.py:283:0-321:38) ç”¨ cross-attention å°† patch embedding æ˜ å°„åˆ° LLM è¯ç©ºé—´ã€‚å¯ä»¥ï¼š
```python
# åœ¨ WaveletPatchEmbedding è¾“å‡ºå‰æ·»åŠ æŠ•å½±ï¼Œä½¿å…¶æ›´æ¥è¿‘æ–‡æœ¬è¯­ä¹‰ç©ºé—´
self.semantic_proj = nn.Sequential(
    nn.Linear(d_model, d_model),
    nn.GELU(),
    nn.Linear(d_model, d_model)
)
```

### 5. å»é™¤å†—ä½™ä»£ç ï¼ˆç«‹å³å¯åšï¼‰
```python
def forward(self, x):
    x = x.float()  # ç»Ÿä¸€è½¬æ¢ä¸€æ¬¡
    B, N, T = x.shape
    
    coeffs = self.swt(x)  # SWT å†…éƒ¨å·²å¤„ç† dtype
    # ... åç»­ä¸å†éœ€è¦å¤šæ¬¡ dtype æ£€æŸ¥
```

---

## ä¼˜åŒ–ä¼˜å…ˆçº§æ’åº

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | é¢„æœŸæ•ˆæœ | å®ç°å¤æ‚åº¦ |
|--------|--------|----------|------------|
| ğŸ”´ é«˜ | ä½ç½®ç¼–ç  | æ˜¾è‘—æå‡ LLM ç†è§£èƒ½åŠ› | ä½ |
| ğŸ”´ é«˜ | å»é™¤å†—ä½™ä»£ç  | ä»£ç æ¸…æ´ + å¾®å°æ€§èƒ½æå‡ | æä½ |
| ğŸŸ¡ ä¸­ | é¢‘æ®µç‹¬ç«‹æŠ•å½± | ä¿ç•™å¤šå°ºåº¦è¯­ä¹‰ç»“æ„ | ä¸­ |
| ğŸŸ¡ ä¸­ | å¯å­¦ä¹ é¢‘æ®µæƒé‡ | ä»»åŠ¡è‡ªé€‚åº” | æä½ |
| ğŸŸ¢ ä½ | è¯­ä¹‰æŠ•å½±å±‚ | ä¸ LLM æ›´å¥½å¯¹é½ | ä½ |

éœ€è¦æˆ‘å®ç°å…¶ä¸­æŸé¡¹æ”¹è¿›å—ï¼Ÿ


---
1. å¯å­¦ä¹ å°æ³¢å‚æ•°
å½“å‰ä½¿ç”¨å›ºå®šå°æ³¢åŸº
æ”¹è¿›ï¼šå­¦ä¹ å°æ³¢æ»¤æ³¢å™¨å‚æ•°

2. è°ƒæ•´åˆ†è§£å±‚æ•°